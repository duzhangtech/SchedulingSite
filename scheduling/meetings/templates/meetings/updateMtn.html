{%extends "loggedin.html"%}
{% load static %}
<body>

{% block content%}
<!--DATA from Python-->
<div id ='lengthStorage'style="display:none;">{{length}}</div>
{%for num in data%}
  <div style="display:none;"id="data_{{forloop.counter}}">{{num}}</div>
  {%endfor%}
  {%for num in specificTimeDispaly%}
  <div style="display:none;"id="specific_{{forloop.counter}}">{{num}}</div>
  {%endfor%}

<div id = "formWrapper">
<form action="update/" method="POST">{% csrf_token %}
    <div id="formLocator1">
    <h3>Please type the name of your meeting</h3>
    <input type="textarea" value = '{{meeting.name}}'name="meeting_name" />
    </div>
    <div id="formLocator2">
    <h3>description</h3>
    <input id="formDescription" value = '{{meeting.description}}'type="textarea" name="meeting_description" />
    </div>
    <h3>Please type the username of those you would like to invite</h3>
    <input type="textarea" name="invited_1" />
    <input type="textarea" name="invited_2" />
    <input type="textarea" name="invited_3" />
    <input type="textarea" name="invited_4" />
    <input type="textarea" name="invited_5" />
    <input type="hidden" value="" id="dataStorage"name= "proposed">
<!---->
<br/>
  <label for='visibility'>Want others to see?</label>
  <input type='checkbox' checked='{{visibility}}'value='True' name='visibility'/>
  <input type="submit" class="submit" value="submit" id="submit"/>
</form>
</div> <!--the end of formWrapper-->

<div id="scheduleUIwrapper">
<div id='scrollWindow'>
 
  <div id="CalWrapper">
 <div id="clockWrapper">
  {% for time in clock %}
  <h3 id ="clockTime">{{ time }}</h3><br/> 
  {% endfor %}
  </div><!--end of clockWrapper-->
  <div id="container">
  <div id="lines_container"></div>
  <div id="col_1" class="calCol"></div>
  <div id="col_2" class="calCol"></div>
  <div id="col_3" class="calCol"></div>
  <div id="col_4" class="calCol"></div>
  <div id="col_5" class="calCol"></div>
  <div id="col_6" class="calCol"></div>
  <div id="col_7" class="calCol"></div>
  </div>
  </div><!--end of CalWrapper-->
</div>
<div id="dateWrapper">
{% for day in date %}
<h3 class="dateSpacer" id="dateSpacer_{{forloop.counter}}">{{ day }}</h3>
{% endfor %}<!--header-->
{% for day in datesForData %}
<h3 class="datesForData" id="datesForData_{{forloop.counter}}">{{ day|date:"SHORT_DATE_FORMAT" }}</h3>
{% endfor %}<!--header-->
</div><!--end of dateWrapper-->


</div><!--end of scheduleUIWrapper-->



<!--JQEURY************************************************************************
**********************************************************************************-->
  <script type="text/javascript"> // visualize the Y grid
  var num=2.439024;
  for(var i=0; i<41; i++){  
  var k = num * i;
  $( "#col_1" ).before("<div class='lines' style='top:"+k+"%'></div>" );
  }
 // visualize the X grid
  var num_row=14.2857;
  for(var i=0; i<8; i++){  
  var k = num_row * i;
  var exist=$("#lines_container").html();
  $( "#lines_container" ).html(exist+"<div class='lines_row' style='left:"+k+"%'></div>" );
  }

  // visualize the even o'clock Y grid
  var num=2.439024;
  for(var i=0; i<41; i=i+4){  
  var k = num * i;
  $( "#col_1" ).before("<div class='bold_lines' style='top:"+k+"%'></div>" );
  }

//***********************************window-size********************************
  var GLOBAL = {};
  GLOBAL.userHeight=$(window).height();

//&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&7core&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
    var CalTopY_base =  -GLOBAL.userHeight/26.5;
    var mouseY;
    var initY;
    var WIDTH = 13.6;
    var counter=0;
    var shortest_height = 2;
    // for inelastic time_slot
    var finalY;
    var gridY = new Array(); 
    var test;  
    var include = new Array();
    var initTopPosition; // carry the top position data from 1st funtion to 2nd
    var message; // carry the message
    var messageTime;
    var messageDate;
    var left_mark = 0;
  var initX = new Array();
for(var i = 0; i < 41; i++){
    gridY[i] = 2.439024 * i; // generate the horizontal grid on the div
}
//generate the left attributes of avail_time slots for each one
for(var i=1; i <8;i++){
  left_mark=14.285714*(i-1);
  initX[i] = 0.4+left_mark*0.9999;
};
//set the default scroll value
$('#scrollWindow').scrollTop( 195 );
//set the new algorithm for scroll------ caltopY = base value(generated by user) + caltop Y updated when scrolling
var CalTopY_scroll = 195;
var CalTopY = CalTopY_scroll/10 + CalTopY_base;
$('#scrollWindow').scroll(function(){
  CalTopY_scroll = $('#scrollWindow').scrollTop();
  CalTopY = CalTopY_base + CalTopY_scroll/10;
});
var data = new Array();
var specific = new Array();
var length = parseInt($("#lengthStorage").html());
for(var ee =0; ee<length;ee++){
  data[0+3*ee] = $("#data_"+(1+3*ee)+"").html();
  data[1+3*ee] = $("#data_"+(2+3*ee)+"").html();
  data[1+3*ee] = parseInt(data[1+3*ee]) - parseInt(data[0+3*ee]);
  data[2+3*ee] = $("#data_"+(3+3*ee)+"").html();

  specific[0+3*ee] = $("#specific_"+(1+3*ee)+"").html();
  specific[1+3*ee] = $("#specific_"+(2+3*ee)+"").html();
  specific[2+3*ee] = $("#specific_"+(3+3*ee)+"").html();
var tempIndex = parseInt(data[2+3*ee]);
var ww =  ee + 1;
$("#col_"+tempIndex).after("<div class='avail_time' id='slot_"+ww+"_finalize' style='height:"+data[1+3*ee]*2.439024+"%; top: "+gridY[data[0+3*ee]]+"%; left:"+initX[data[2+3*ee]]+"%; position:absolute; width:"+WIDTH+"%; '></div>");

$('#slot_'+ww+'_finalize').html('<div style="display: none;" id="dataCarrier_date_'+ww+'">'+'</div>'+"<div class='dataCarrier' id='dataCarrier_"+ww+"'>"+specific[0+3*ee]+specific[1+3*ee]+specific[2+3*ee]+"</div>"+'<div class="avail_time_bottom" id="slot_'+ww+'_bottom" style="width:100%; position:absolute; background-color: red; height:5px; bottom: 0;"></div>');
$('#dataCarrier_date_'+ww).html($('#datesForData_'+tempIndex).html());
$('#dataCarrier_'+ww).html("<a class='trashcan' href='#'><img style='width:1em;height:1em;' src={% static 'meetings/image/trashcan.png' %} /></a>");

counter = ww;
    if($("#slot_"+counter+"_finalize").attr('id') == "slot_"+counter+"_finalize"&& jQuery.inArray(counter , include) === -1){
      include.push(counter);
    };
};

$('body').mousemove(function(){
  dragResize();
});
//Drag&Resize:
var dragResize=function(){
      $(".avail_time").draggable({ 
          cursor: 'move',
          axis: "y",
          snap:'.lines',
          snapTolerance: 30,
          snapMode:'inner',
          cancel:'.trashcan',
          containment: '#container',
      });

      $(".avail_time").resizable({
          snap:'.lines',
          snapTolerance: 30,
          handles: 's',
          containment: '#container',        
      });
};
//different slot generators for seven lanes
var column_init = function(num){
$("#col_"+num).mousedown( function(e) {


   counter = counter+1;
   initY = CalTopY+(e.pageY-8)/10;  // % conversion 
   var nearestY= gridY[0];
  for(var h=0;h<41;h++){
      if(gridY[h+1]>initY){
        nearestY = gridY[h];
        break;
      } 
  }
  messageDate = $("#datesForData_"+num).html();
//$('#col_1').after("<div style='position: absolute; left: 200px; font-size:5em;'>"+initY+"</div>");
  initTopPosition = nearestY;
   $('#col_'+num).after("<div class='avail_time' id='slot_"+counter+"' style='top: "+nearestY+"%; left:"+initX[num]+"%; position:absolute; width:"+WIDTH+"%; ' ></div>");

   $("#slot_"+counter+"").html("<div style='display: none;'id='dataCarrier_date_"+counter+"'>"+messageDate+"</div><div style='display:none;'class='dataCarrier' id='dataCarrier_"+counter+"'></div><div class='avail_time_bottom' id='slot_"+counter+"_bottom' style='width:100%; position:absolute; background-color: red; height:5px; bottom: 0;' ></div>");
   
   dragResize();
}); 
};


column_init(7);
column_init(6);
column_init(5);
column_init(4);
column_init(3);
column_init(2);
column_init(1);
//delete the current selection

//&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&xcontinue CORE&&&&&&&&&&&&&&7
$(document).mousemove( function(e) {

   mouseX = e.pageX; 
   mouseY = CalTopY+(e.pageY-8)/10;   //  % conversion
   //calculate the nearest benchmark
   var nearestY_new= gridY[0];
    for(var i=0;i<39;i++){
        if(gridY[i]>mouseY){
          nearestY_new = gridY[i];
            break;
        }   
    }
    //subtract the initial benchmark
    nearestY_new = nearestY_new - initTopPosition;  
// TEST--------------------$('#col_1').after("<div style='position: absolute; font-size:5em;'>"+nearestY+"</div>");
   $('#slot_'+counter+'').css({"height":""+nearestY_new+"%"})
});  


$(document).mouseup( function(e) {
    $('#slot_'+counter+'').attr("id","slot_"+counter+"_finalize");
//$("#col_2").before("<div>"+processData[1]+"</div>");
    $('#dataCarrier_'+counter+'').css("display","");
//1-3-2013   make sure that the slot exists and it does not exist in the array
    if($("#slot_"+counter+"_finalize").attr('id') == "slot_"+counter+"_finalize"&& jQuery.inArray(counter , include) === -1){
      include.push(counter);
    };
});      

//parse the selected begining time
var processMessageTime = function(messageTime){
if(messageTime <10){
  if(messageTime%2 === 0 ){
    messageTime = (messageTime/2) + 5;
    messageTime = "0" + messageTime + ":00";
  }
  else{
    messageTime = ((messageTime-1)/2) +5
    messageTime = "0" + messageTime + ":30"
  }
}
else {
  if(messageTime%2 === 0 ){
    messageTime = (messageTime/2) + 5;
    messageTime = messageTime + ":00";
  }
  else{
    messageTime = ((messageTime-1)/2) +5
    messageTime = messageTime + ":30"
  }
}

if(messageTime === "24:00"){
  messageTime = "0:00";};
if(messageTime === "24:30"){
  messageTime = "0:30";};
if(messageTime === "25:00"){
  messageTime = "1:00"};
return messageTime;
}

var containerHeight = $("#container").height();
var processData = new Array();

$(document).mousemove( function(e) {
  //$('#formDescription').val(include[0]+''+include[1]+''+include[2]+''+include[3]+''+include[4]+''+include[5]+''+include[6]+'');
  for(var w=1; w < counter+1;w++){
    var topForData = parseInt($("#slot_"+w+"_finalize").css("top"));
    var bottomForData = $("#slot_"+w+"_finalize").height();
    bottomForData = processMessageTime(Math.round(((bottomForData + topForData)/containerHeight)/0.024378));
    topForData = processMessageTime(Math.round((topForData/containerHeight)/0.024378));
    $("#dataCarrier_"+w+"").html(""+topForData+"-"+bottomForData+"<a class='trashcan' href='#'><img style='width:1em;height:1em;' src={% static 'meetings/image/trashcan.png' %} /></a>");
//delete feature

//1-3-2014 unbind() stops multiple firing
$('.trashcan').unbind().click(function(){

      var zzz = $(this).parent().attr('id').replace(/[^\d.]/g,  "");
      zzz = parseInt(zzz);
      var index = jQuery.inArray(zzz, include);
      include.splice(index,1);
      $(this).parent().parent().remove();

});

};

});
// submit the data
var processData = new Array();

$("#submit").click(function(e){
  for(var cc=0; cc < include.length; cc++){
// replace : and '' and get rid of the trashcan image symbol 12.31.2013
    processData[cc] = $("#dataCarrier_"+include[cc]+"").html().replace(/[^\d.]/g, "").slice(0, 8) + $("#dataCarrier_date_"+include[cc]+"").html().replace(/[^\d.]/g, "");
  };
  var proposed = "";
  for(var ccc=0; ccc < include.length; ccc++){
    proposed = proposed + processData[ccc];
  }; 
  $("#dataStorage").val(proposed);
});


//merge the messages

</script>

{%endblock%}
</body>